<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:f="http://java.sun.com/jsf/core"
                xmlns:h="http://java.sun.com/jsf/html"
                xmlns:p="http://primefaces.org/ui"
                xmlns:ui="http://java.sun.com/jsf/facelets"
                template="./WEB-INF/templates/template.xhtml">

    <ui:define name="navigation">
        <li><span>PREVISIÓN DE CAUDALES</span></li>
    </ui:define>

    <ui:define name="content">
        <h:panelGrid columns="4" style="margin: 10px 0 0 10px;" styleClass="structure">
            <p:outputLabel for="selectStation" value="Estación:" />
            <p:selectOneMenu id="selectStation" 
                             value="#{datosBean.selectedStation}" 
                             converter="estacionConverter" 
                             required="false" 
                             var="station" 
                             filter="true" filterMatchMode="contains" 
                             style="margin-right: 10px; width: 16em;">
                <p:ajax listener="#{datosBean.stationChange}" update="grafica,enlaceExportar" />
                <f:selectItem itemLabel="" itemValue="" />
                <f:selectItems itemLabel="#{estacion.estacionId} - #{estacion.descripcion}"
                               itemValue="#{estacion}" 
                               value="#{estacionBean.entityList}" 
                               var="estacion" />
                <p:column>
                    <h:outputText value="#{station.estacionId} - #{station.descripcion}" />
                </p:column>
            </p:selectOneMenu>
            <h:panelGroup id="enlaceExportar">
                <p:commandLink onclick="export_png()" rendered="#{datosBean.selectedStation ne null}" style="text-decoration: none;">
                    <h:outputText styleClass="fa fa-download" value=" " /> <h:outputText style="font-weight: bold;" value=" GUARDAR GR&Aacute;FICA" /><h:outputText value=", en formato " /><h:outputText style="font-weight: bold;" value="PNG" />
                </p:commandLink>
            </h:panelGroup>
        </h:panelGrid>
        
        <p:ajaxStatus onstart="PF('statusDialog').show()" onsuccess="PF('statusDialog').hide()" /> <!-- onerror="" -->
        <p:dialog widgetVar="statusDialog" modal="true" draggable="false" closable="false" resizable="false" showHeader="false">
            <p:graphicImage library="images" name="ajax-loader.gif" />
        </p:dialog>  
        
        <p:outputPanel deferred="false" id="grafica" style="min-height:512px;">
            <p:outputPanel deferred="false" id="chart" rendered="#{datosBean.selectedStation != null}">
                <div id="amchart" style="height: 535px; width: 100%;"></div>

                <script type="text/javascript">
                var chartData = #{datosBean.chartData};
                </script>
                
                <script type="text/javascript">
                //$(function() {
                    AmCharts.dayNames=['Domingo','Lunes','Martes','Miercoles','Jueves','Viernes','Sabado'];
                    AmCharts.shortDayNames=['Dom','Lun','Mar','Mie','Jue','Vie','Sab'];
                    AmCharts.monthNames=['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
                    AmCharts.shortMonthNames=['Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct','Nov','Dic'];

                    var chart = AmCharts.makeChart('amchart', {
                        //autoMargins: true,
                        //autoResize: true,

                        categoryAxis: {
                            dashLength: 1,		
                            dateFormats: [
                                { period: 'fff',  format: 'JJ:NN'  },
                                { period: 'ss',   format: 'JJ:NN'  },
                                { period: 'mm',   format: 'JJ:NN'  },
                                { period: 'hh',   format: 'JJ:NN'  },
                                { period: 'DD',   format: 'DD-MMM' },
                                { period: 'WW',   format: 'DD-MMM' },
                                { period: 'MM',   format: 'MMM-YY' },
                                { period: 'YYYY', format: 'YY'     }
                            ],
                            equalSpacing: true,
                            //gridAlpha: 0.2,
                            //minorGridEnabled: true,
                            minPeriod: '5mm',
                            parseDates: true
                        },
                        
                        categoryField: 'category',

                        chartCursor: {
                            color: '#000000',
                            pan: false,
                            categoryBalloonColor: '#888888',
                            categoryBalloonDateFormat: 'DD-MMM JJ:NN',
                            cursorAlpha: 0.2,
                            //cursorPosition: 'mouse',
                            //oneBalloonOnly: true,
                            pan: false
                        },

                        chartScrollbar: {
                            autoGridCount: true,
                            color: '#444444',
                            //graph: 'Discharge_forecast',
                            //graphType: 'smoothedLine',
                            offset: 10,
                            oppositeAxis: true,
                            scrollbarHeight: 30
                        },                    

                        //creditsPosition: 'bottom-right',
                        
                        dataDateFormat: 'YYYY-MM-DD JJ:NN:SS',						

                        dataProvider: chartData,

                        exportConfig: {
                            fileName: '#{datosBean.selectedStation.descripcion}',
                            menuBottom: '16px',
                            menuRight: '48px',
                            menuItems: []
                        },

                        graphs: [ {
                            balloonText: '[[category]]<br/><b><span>Caudal SAIH = [[value]] m3/s</span></b>',
                            bullet: 'round',
                            bulletSize: 5,
                            connect: false,
                            //fillAlphas: 0,	
                            forceGap: true,
                            gapPeriod: 0,
                            hideBulletsCount: 120,
                            hidden: false,
                            id: 'Q_obs',					
                            //legendPeriodValueText: ' ( media = [[value.average]] m3/s)',
                            legendValueText: '[[value]] m3/s',
                            //lineAlpha: 0.9,			
                            lineColor: '#888888',
                            lineThickness: 2,
                            title: 'Caudal SAIH',
                            type: 'smoothedLine',		
                            valueAxis: 'v1',
                            valueField: 'Q_obs'
                        }
                        <ui:fragment rendered="#{datosBean.selectedStation.tipoEstacion eq 'Embalse'}">
                        , {
                            balloonText: '[[category]]<br/><b><span>Caudal de aportación SAIH = [[value]] m3/s</span></b>',
                            bullet: 'round',
                            bulletSize: 5,
                            connect: false,
                            //fillAlphas: 0,	
                            forceGap: true,
                            gapPeriod: 0,
                            hideBulletsCount: 120,
                            hidden: false,
                            id: 'I_obs',					
                            //legendPeriodValueText: ' ( media = [[value.average]] m3/s)',
                            legendValueText: '[[value]] m3/s',
                            //lineAlpha: 0.9,			
                            lineColor: '#2222AA',
                            lineThickness: 2,
                            title: 'Caudal de aportación SAIH',
                            type: 'smoothedLine',		
                            valueAxis: 'v1',
                            valueField: 'I_obs'
                        }
                        </ui:fragment>
                        , {
                            balloonText: '[[category]]<br/><b><span>Caudal simulado = [[value]] m3/s</span></b>',
                            bullet: 'round',
                            bulletSize: 5,
                            connect: false,
                            //fillAlphas: 0,	
                            forceGap: true,
                            gapPeriod: 0,
                            hideBulletsCount: 120,
                            hidden: false,
                            id: 'Discharge',					
                            //legendPeriodValueText: ' (media = [[value.average]] m3/s)',
                            legendValueText: '[[value]] m3/s',
                            //lineAlpha: 0.9,			
                            lineColor: '#00CCFF',
                            lineThickness: 2,
                            title: 'Caudal simulado',
                            type: 'smoothedLine',		
                            valueAxis: 'v1',
                            valueField: 'Discharge'
                        }
                        , {
                            balloonText: '[[category]]<br/><b><span>Caudal pronóstico = [[value]] m3/s</span></b>',
                            bullet: 'round',
                            bulletSize: 5,
                            connect: false,
                            //fillAlphas: 0,	
                            forceGap: true,
                            gapPeriod: 0,
                            hideBulletsCount: 120,
                            hidden: false,
                            id: 'Discharge_forecast',					
                            //legendPeriodValueText: ' (media = [[value.average]] m3/s)',
                            legendValueText: '[[value]] m3/s',
                            //lineAlpha: 0.9,			
                            lineColor: '#CC00CC',
                            lineThickness: 2,
                            title: 'Caudal pronóstico',
                            type: 'smoothedLine',		
                            valueAxis: 'v1',
                            valueField: 'Discharge_forecast'
                        }
                        ],

                        hideCredits: true,

                        language: 'es',
                        
                        legend: {
                            //align: 'center',
                            //equalWidths: true,
                            spacing: 32,
                            useGraphSettings: true,
                            valueAlign: 'left',
                            valueWidth: 152 // 200		
                        },

                        //marginLeft: 10,

                        numberFormatter: {
                            decimalSeparator: ',',
                            precision: 2,
                            thousandsSeparator: '.'
                        },

                        pathToImages: 'resources/js/amcharts_3.21.14.free/images/',
                        
                        responsive: {
                            enabled: true
                        },
                        
                        theme: 'light',

                        titles: [ {
                            bold: true,                
                            size: 15,
                            text: '#{datosBean.title}'
                        } ],

                        type: 'serial',

                        valueAxes: [ {
                            autoGridCount: true,
                            axisAlpha: 1,
                            axisColor: '#000000',
                            axisThickness: 2,
                            color: '#000000',
                            //gridAlpha: 0.1,
                            gridColor: '#000000',
                <ui:fragment rendered="#{datosBean.umbralActivacion gt 0}">
                            guides: [ {
                                //above: true,
                                balloonText: 'Caudal de Activación',
                                dashLength: 4,
                                inside: true,
                                label: 'Activación (#{datosBean.umbralActivacion} m3/s)',
                                lineAlpha: 1,
                                lineColor: '#FFDD00',
                                lineThickness: 1,
                                logarithmic: true,
                                position: 'left',
                                value: #{datosBean.umbralActivacion}
                            }, {                                above: true,
                                balloonText: 'Caudal de Pre-alerta',
                                dashLength: 4,
                                inside: true,
                                label: 'Pre-alerta (#{datosBean.umbralPrealerta} m3/s)',
                                lineAlpha: 1,
                                lineColor: '#FF7700',
                                lineThickness: 1,
                                logarithmic: true,
                                position: 'left',
                                value: #{datosBean.umbralPrealerta}
                            }, {
                                balloonText: 'Caudal de Alerta',
                                dashLength: 4,
                                inside: true,
                                label: 'Alerta (#{datosBean.umbralAlerta} m3/s)',
                                lineAlpha: 1,
                                lineColor: '#FF0000',
                                lineThickness: 1,
                                logarithmic: true,
                                position: 'left',
                                value: #{datosBean.umbralAlerta}
                            } ],
                </ui:fragment>
                            id: 'v1',
                            includeGuidesInMinMax: true,
                            //inside: false,
                            //minimum: 0,
                            //maximum: #{datosBean.umbralAlerta},
                            offset: 0,
                            position: 'left',
                            precision: 2,
                            title: 'Caudal (m3/s)',
                            titleColor: '#000000'
                        } ],			

                        valueScrollbar: {
                            enabled: false,
                            //graph: 'Discharge_forecast',
                            offset: 0,
                            scrollbarHeight: 30
                        },

                        zoomOutButton: {
                            backGroundAlpha: 0.15,
                            backGroundColor: '#000000'
                        },

                        zoomOutText: 'Ver serie completa'
                    });
                    
                //});
                
                <ui:fragment rendered="#{datosBean.selectedStation != null}">
                function export_png() {
                    //chart.AmExport.output('png');
                    chart.export.capture({}, function() {
                        this.toPNG({}, function(data) {
                            this.download(data, this.defaults.formats.PNG.mimeType, '#{datosBean.selectedStation.estacionId}.png');
                        });
                    });
                }
                </ui:fragment>
                </script>
            </p:outputPanel>
        </p:outputPanel>
    </ui:define>        
</ui:composition>